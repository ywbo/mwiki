## 消息中间件

#### 0、平时有使用过那些消息中间件？它们有什么区别？ 

平时工作中使用过`RabbitMQ`，`Kafka`。

| 特性                    | RabbitMQ                                           | Kafka                                                        |
| ----------------------- | -------------------------------------------------- | ------------------------------------------------------------ |
| 单机吞吐量              | 万级，比Kafka低一个等级                            | 10万级，高吞吐，一般配合大数据类的系统来进行实时数据计算，体质采集等场景。 |
| topic数量对吞吐量的影响 | —（RabbitMQ中无topic概念一说）                     | topic从几十到几百个时，吞吐量会大幅下降，在同等机器下，Kafka尽量保证topic数量不要过多，如果出现要支撑大规模的topic，需要增加更多的机器资源。 |
| 时效性                  | 微秒级，这是RabbitMQ一大特点，延时最低。           | 延迟在ms以内                                                 |
| 可用性                  | 高可用，基于主从架构实现高可用                     | 非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用。 |
| 消息可靠性              | 基本不会丢失消息                                   | 经过参数优化，可以做到0丢失                                  |
| 功能支持                | 基于Erlang开发，并发能力很强，性能极好，延时很低。 | 功能较为简单，主要支持简单的MQ功能，在大数据领域实时计算以及日志采集被大规模使用。 |

#### 1、为什么使用消息队列？消息队列有什么优点，缺点？ 

要根据自己业务需求，实际使用场景出发，选择最为合适的就好。不管使用的是何种类型的MQ，业务场景有很多，集中起来比较核心就是3个：**`解耦`**、**`异步`**、**`削峰`**。下面来逐个说明：

1. > ###### **解耦**

   有这么一个场景。A系统发送数据到B、C、D三个系统，通过接口调用发送。如果E系统也要这个数据呢？那如果C系统现在不需要这个数据了呢？A系统负责人估计头皮发麻，都要崩溃了......

   ![image-20220830232558086](C:%5CUsers%5C%E4%BA%8E%E6%96%87%E6%B3%A2%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220830232558086.png)

   在这个场景中，A系统跟其他七七八八的系统严重耦合。A系统产生了一条关键的数据，很多系统都需要A系统将这个数据发送过来。A系统要时时刻刻考虑B、C、D、E四个系统挂了改怎么办？要不要重新发送数据？要不要把消息存起来？A最直接的结果就是头发花白，最终猝死。:skull:

   那么换个角度，如果使用MQ，A系统产生一条数据，发送到MQ中，哪个系统需要数据自己去MQ里面去消费。如果新系统需要数据，直接从MQ里消费即可。如果某个系统不需要这条数据了，就取消对MQ消息的消费即可。这样下来，A系统压根儿需要去考虑给谁发送消息，不需要维护这个那个七七八八的代码，也不需要考虑人家是否调用成功，失败或者超时的情况。

   ![image-20220830232717384](C:%5CUsers%5C%E4%BA%8E%E6%96%87%E6%B3%A2%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20220830232717384.png)

   **`【总结】通过对于消息MQ队列的使用，Pub/Sub发布订阅消息这么一个模型，A系统就跟其他系统实现了彻底解耦。`**

2. > ###### **异步**

   再来看一个场景，A系统接收一个请求，需要在自己本地写库，还需要在B、C、D三个系统写库，自己本地写库需要3ms，B、C、D三个系统写库分别需要200ms，300ms，100ms。最终请求总时间是：3+200+300+100 = 603ms，如果数据量再大一些，只会比这个时间更长，这就导致，用户感觉搞个东西，怎么响应这个慢。

   ![1661862453165](D:\OpenCode\1661862453165.png)

   一般互联网类的企业，对于用户操作响应在200ms以内，对于用户而言几乎是无感的。

   如果**`使用MQ`**，那么A系统连续发送3条消息到MQ队列中，加入耗时5ms，A系统从接受一个请求到返回响应给用户，总时长是 3+5=8ms，对于用户而言，就是点击个页面是事儿，相比于之前没有使用MQ的场景，简直不要太爽啊！

   ![image-20220830232823820](%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6.assets/image-20220830232823820.png)

3. > ###### **`削峰`**

   每天 0:00 到 12:00，A 系统风平浪静，每秒并发请求数量就 50 个。结果每次一到 12:00 ~ 13:00 ，每秒并发请求数量突然会暴增到 5k+ 条。但是系统是直接基于 MySQL 的，大量的请求涌入 MySQL，每秒钟对 MySQL 执行约 5k 条 SQL。

   一般的 MySQL，扛到每秒 2k 个请求就差不多了，如果每秒请求到 5k 的话，可能就直接把 MySQL 给打死了，导致系统崩溃，用户也就没法再使用系统了。

   但是高峰期一过，到了下午的时候，就成了低峰期，可能也就 1w 的用户同时在网站上操作，每秒中的请求数量可能也就 50 个请求，对整个系统几乎没有任何的压力。

   ![image-20220830232909789](%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6.assets/image-20220830232909789.png)

   如果请求，每秒5k个请求写入MQ，A系统每秒最多能处理2k个请求，因为MySQL每秒钟最多处理2k个请求。A系统从MQ拉取请求，每秒就拉取2k个请求，不要超过自己每秒能处理的最大请求数量就ok，这样下来，哪怕是高分期的时候，A系统也绝对不可能会挂掉，而MQ每秒5k个请求进来，就2k个出去，结果就导致在高峰期（午/晚间1小时），可能有几十万甚至几百万的请求积压在MQ中。

   ![image-20220830235245122](%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6.assets/image-20220830235245122.png)

   这个短暂的高峰期积压是 ok 的，因为高峰期过了之后，每秒钟就 50 个请求进 MQ，但是 A 系统依然会按照每秒 2k 个请求的速度在处理。所以说，只要高峰期一过，A 系统就会快速将积压的消息给解决掉。

   > **消息队列的优缺点**

   优点上面已经说了，就是**在特殊场景下有其对应的好处**，**解耦**、**异步**、**削峰**。

   缺点有以下几个：

   - ###### 系统可用性降低

     系统引入的外部依赖越多，越容易挂掉。本来你就是 A 系统调用 BCD 三个系统的接口就好了，ABCD 四个系统还好好的，没啥问题，你偏加个 MQ 进来，万一 MQ 挂了咋整？MQ 一挂，整套系统崩溃，你不就完了？如何保证消息队列的高可用。

   - ###### 系统复杂度提高

     硬生生加个 MQ 进来，你怎么保证消息没有重复消费？怎么处理消息丢失的情况？怎么保证消息传递的顺序性？头大头大，问题一大堆，痛苦不已。

   - ###### 一致性问题

     A 系统处理完了直接返回成功了，人都以为你这个请求就成功了；但是问题是，要是 BCD 三个系统那里，BD 两个系统写库成功了，结果 C 系统写库失败了，咋整？你这数据就不一致了。

     所以消息队列实际是一种非常复杂的架构，你引入它有很多好处，但是也得针对它带来的坏处做各种额外的技术方案和架构来规避掉，做好之后，你会发现，妈呀，系统复杂度提升了一个数量级，也许是复杂了 10 倍。但是关键时刻，用，还是得用。


#### 2、如何保证消息队列的高可用？ 

#### 3、如何保证消息不被重复消费？（或者说如何保证消息消费的幂等性？） 

#### 4、如何保证消息的可靠性传输？（或者说如何处理消息丢失的问题？） 

#### 5、如何保证消息的顺序性？ 

#### 6、如何解决消息队列的延时以及过期失效问题？ 

#### 7、消息队列满了以后该怎么处理？ 

#### 8、有几百万消息持续积压了几小时，说说怎么解决？ 

#### 9、如果让你来设计一个消息队列中间件，该如何进行架构设计？说说你的思路。
