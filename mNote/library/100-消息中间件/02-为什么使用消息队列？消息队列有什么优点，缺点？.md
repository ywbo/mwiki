> ## 1、为什么使用消息队列？消息队列有什么优点，缺点？ 
>

要根据自己业务需求，实际使用场景出发，选择最为合适的就好。不管使用的是何种类型的MQ，业务场景有很多，集中起来比较核心就是3个：**`解耦`**、**`异步`**、**`削峰`**。下面来逐个说明：

1. > ###### **解耦**

   有这么一个场景。A系统发送数据到B、C、D三个系统，通过接口调用发送。如果E系统也要这个数据呢？那如果C系统现在不需要这个数据了呢？A系统负责人估计头皮发麻，都要崩溃了......

   ![](02-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%82%B9%EF%BC%8C%E7%BC%BA%E7%82%B9%EF%BC%9F.assets/02-1.png)

   在这个场景中，A系统跟其他七七八八的系统严重耦合。A系统产生了一条关键的数据，很多系统都需要A系统将这个数据发送过来。A系统要时时刻刻考虑B、C、D、E四个系统挂了改怎么办？要不要重新发送数据？要不要把消息存起来？A最直接的结果就是头发花白，最终猝死。:skull:

   那么换个角度，如果使用MQ，A系统产生一条数据，发送到MQ中，哪个系统需要数据自己去MQ里面去消费。如果新系统需要数据，直接从MQ里消费即可。如果某个系统不需要这条数据了，就取消对MQ消息的消费即可。这样下来，A系统压根儿需要去考虑给谁发送消息，不需要维护这个那个七七八八的代码，也不需要考虑人家是否调用成功，失败或者超时的情况。

   ![](02-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%82%B9%EF%BC%8C%E7%BC%BA%E7%82%B9%EF%BC%9F.assets/02-2.png)

   **`【总结】通过对于消息MQ队列的使用，Pub/Sub发布订阅消息这么一个模型，A系统就跟其他系统实现了彻底解耦。`**

3. > ###### **`削峰`**

   每天 0:00 到 12:00，A 系统风平浪静，每秒并发请求数量就 50 个。结果每次一到 12:00 ~ 13:00 ，每秒并发请求数量突然会暴增到 5k+ 条。但是系统是直接基于 MySQL 的，大量的请求涌入 MySQL，每秒钟对 MySQL 执行约 5k 条 SQL。

   一般的 MySQL，扛到每秒 2k 个请求就差不多了，如果每秒请求到 5k 的话，可能就直接把 MySQL 给打死了，导致系统崩溃，用户也就没法再使用系统了。

   但是高峰期一过，到了下午的时候，就成了低峰期，可能也就 1w 的用户同时在网站上操作，每秒中的请求数量可能也就 50 个请求，对整个系统几乎没有任何的压力。

   ![](02-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%82%B9%EF%BC%8C%E7%BC%BA%E7%82%B9%EF%BC%9F.assets/02-5.png)

   如果请求，每秒5k个请求写入MQ，A系统每秒最多能处理2k个请求，因为MySQL每秒钟最多处理2k个请求。A系统从MQ拉取请求，每秒就拉取2k个请求，不要超过自己每秒能处理的最大请求数量就ok，这样下来，哪怕是高分期的时候，A系统也绝对不可能会挂掉，而MQ每秒5k个请求进来，就2k个出去，结果就导致在高峰期（午/晚间1小时），可能有几十万甚至几百万的请求积压在MQ中。

   ![](02-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E7%82%B9%EF%BC%8C%E7%BC%BA%E7%82%B9%EF%BC%9F.assets/02-6.png)

   这个短暂的高峰期积压是 ok 的，因为高峰期过了之后，每秒钟就 50 个请求进 MQ，但是 A 系统依然会按照每秒 2k 个请求的速度在处理。所以说，只要高峰期一过，A 系统就会快速将积压的消息给解决掉。
   
   