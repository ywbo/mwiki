> ## 3、如何保证消息不被重复消费？（或者说如何保证消息消费的幂等性？） 
>

拿到问题先不要慌，咽口口水压压惊。:smile_cat: 首先可以聊聊大概`有哪些场景会导致重复消费的问题`。

  首先，比如众多MQ（RabbitMQ，ActiveMQ，Kafka）中，都有可能会出现重复消费的问题，这是很正常的。正常？为什么？因为这个问题通常不是由MQ保证的，是由我们研发同学来保证的。下面我们就来说说Kafka中是如何 重复消费的？

Kafka实际上有一个 `offset` 的概念，即就是每个消息写进去。都有一个offset，代表着消息的序号，然后 `consumer`消费了消息之后，每隔一段时间（定时定期），会把自己消费过的消息的 offset 提交一下，表示说：“我已经消费过了，下次要是重启啥的，你就让我从上次消费的 offset 来继续消费吧。”

凡事都有个意外，没有意外的话，意外就要发生了。比如我们之前生产经常遇到的问题，就是当你有时候重启系统，但是这个重启也要看怎么重启了？如果碰到着急点儿的，或者是新手，直接把进程 `kill` 掉，再重启，这会导致一个很严重的问题，消费者 `consumer` 有些消息处理了，但是还没有来得及提交 `offset`，哦豁~ 尴了个噶~ 重启之后，有些消息就会重复消费一次。

:chestnut: 举个栗子

有这么一个场景。数据1/2/3依次进入 Kafka，Kafka会给这个三条数据每条分配一个 offset，代表着这条数据的序号，我们就假设分配的 `offset 依次是 101/102/103`。消费者从 Kafka 去消费的时候，也会按照这个顺序取消费。假如当消费者消费了 `offset = 101` 这条消息，刚准备提交 `offset` 到 `Zookeeper`，此时消费者进程被重启了。那么此时消费过的数据 `1/2` 的 offset 并没有提交了，Kafka 也就不知道你已经消费了 `offset = 100` 的这条消息数据。那么重启后，消费找 Kafka 说，嘿~ 哥们儿，刚我重启了，你告诉我上次消息消费到哪个地儿了，把那个地方后面的数据继续给我传过来。由于之前的 offset 没有提交成功，那么数据 1/2 会再次传过来，如果此时消费者没有去重的话，那么就会导致`重复消费`。

【注意】新版的 Kafka 已经将 `offset` 的存储从 `Zookeeper` 转移至 `Kafka brokers`，并使用内部位移主题 `_consumer_offsets` 进行存储。

![image-20220904224346742](04-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E8%A2%AB%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%EF%BC%9F.assets/image-20220904224346742.png)
如果消费者干的事儿是拿一条数据就往数据库写一条，会导致说，你可能把数据 1/2 在数据库插入了2次，那么数据就错啦。其实重复消费的问题不可怕，可怕的是你没考虑到重复消费之后，`怎么保证幂等性`。

:chestnut: 举个栗子

假如你有个系统，消费一条消息就往数据库里插入一条数据，要是你一个消息重复消费了两次，你不就插入了两条数据，不符合我们的预期，这数据不就错了吗？但是你要消费到第二次的时候，自己判断一下是否已经消费过了，如若已经消费过了，就直接丢弃，这样不就只保留了一条数据，从而保证了数据的正确性。

`一条数据重复出现两次，数据库里就只有一条是数据，这就保证了系统的幂等性。`

`那何谓幂等性，通俗来讲，就是一条数据，或者一个请求，给你重复来了多次，你得确保对应的数据是不会改变的，不能出错。`

那么此时第二个问题来了，怎么保证消息队列的消费的幂等性？

这里可不能张口就来，最好是结合业务来思考，这里可以尝试从以下几个角度聊聊：

- 比如你哪个数据要写库，你先根据数据的主键查一把，如果这条数据有了，那你就别插入了，`update` 一下可以的吧。

- 比如你要写入的是 Redis，那更好了，每次都是 `SET`，天然的幂等性。
- 比如你不是上面两个场景，那座的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加上全局唯一的标识（id），类似于订单id之类的东西，这里可以捎着讲讲`分布式ID生成策略`（雪花算法，百度UidGenerator，美团的Leaf），然后你这里消费到了之后，现根据这个id，比如去Redis或者数据库查一下之前有没有消费过吗？如果没有，你就处理，然后这个 id 写入 Redis 或者数据库。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。

- 比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入就会报错，不会导致数据库中出现脏数据。

![image-20220907223103813](04-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E8%A2%AB%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%EF%BC%9F.assets/image-20220907223103813.png)

【总结】当然，如何保证MQ的消息是幂等性的，在实际应用中需要结合具体的业务来分析。