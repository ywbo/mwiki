## Redis 中 Master-Slaves、Sentinel、Cluster 原理与区别

Redis 服务器的高可用是一个老生常谈的问题了。那么今天我们就继续聊聊这个常聊常新的话题。

如何保证备份机器的数据是原始服务器的完整数据呢？这个时候我们就需要 `哨兵 + 主从复制`。

> - **Sentinel（哨兵）**：可以管理过个 Redis 服务器，它提供了监控，提醒以及自动故障转移的功能。
> - **Replication（复制）**：是负责让一个 Redis 服务器可以配备多个备份的服务器。
>

> Redis 正是利用了 `哨兵 + 主从复制` 这种模式来保证了其高可用。

### 1. Sentinel（哨兵）

> `哨兵` 是 Redis 集群架构中非常重要的一个组件，哨兵的出现，在一定程度上极大的解决了`主从复制`时需要认为干预的问题。

![1663643944318](D:\OpenCode\mwiki-main\mNote\library\99-缓存\1663643944318.png)

#### Redis 中哨兵模式的主要功能

- 集群监控：负责监控 Redis Master 和 Slave 进程是否正常工作；
- 消息通知：如果某个 Redis 实例有故障，那么哨兵负责发动消息作为报警通知给管理员；
- 故障转移：如果 Master node 挂掉了，会自动转移到 Slave node上；
- 配置中心：如果故障发生了转移，通知 Client 客户端新的 Master 地址。

#### Redis 哨兵的高可用

【原理】当节点主线故障时，由 Redis Sentinel自动完成规章发现和转移，并通知应用方，实现高可用。

- 哨兵模式建立了多个哨兵节点（进程），共同监控数据节点的运行状况。
- 同时哨兵节点之间也是互相通信的，交换对主从节点的监控状况。
- 每隔 1 秒每个哨兵回想整个集群：Master 主服务器 + Slave 从服务器 + 其他 Sentinel（哨兵）进程，发送一次 `ping` 命令做一次心跳检测。

这个就是 哨兵 用来判断节点是否正常的重要依据，这里涉及两个新的概念：**主观下线**，**客观下线**

- **主观下线**：**一个哨兵节点判定主节点 down 掉即为 主观下线。**
- **客观下线**：**只有半数哨兵节点都主观判定主节点down掉，此时多个哨兵节点交换主观判定结果，才会判定主节点客观下线。**

> 【总结】基本上哪个哨兵节点最先判断出这个主节点客观下线，就会在各个哨兵节点中发起投票机制Raft算法（选举算法），最终被投为领导者的哨兵节点完成主从自动化切换的过程。

### 2. Master-Slave Replication（主从复制）

Redis为了解决单点数据库问题，会把数据复制多个副本部署到其他节点上，通过复制，实现Redis的高可用性，实现对数据的冗余备份，保证数据和服务的高度可靠性。

![1663643461854](D:\OpenCode\mwiki-main\mNote\library\99-缓存\1663643461854.png)

数据同步的步骤：

##### ① 从数据库向主数据库发送sync(数据同步)命令。

##### ② 主数据库接收同步命令后，会保存快照，创建一个RDB文件。

##### ③ 当主数据库执行完保持快照后，会向从数据库发送RDB文件，而从数据库会接收并载入该文件。

##### ④ 主数据库将缓冲区的所有写命令发给从服务器执行。

##### ⑤ 以上处理完之后，之后主数据库每执行一个写命令，都会将被执行的写命令发送给从数据库。

【注意】：在 Redis2.8 之后，主从断开重连后会根据断开之前最新的命令偏移量进行增量复制 。

### 3. Redis Cluster（集群）

![1663644314649](D:\OpenCode\mwiki-main\mNote\library\99-缓存\1663644314649.png)

为了解决单机Redis容量有限的问题，将数据按一定的规则分配到多台机器，内存/QPS不受限于单机，可受益于分布式集群高扩展性。集群模式提高并发量。

### 4. Redis 主从复制、哨兵和集群三者区别

**主从复制是为了数据备份**，**哨兵是为了高可用**，Redis主服务器挂了哨兵可以切换，**集群则是因为单实例能力有限，搞多个分散压力**。

简短总结如下：

**Master-Slave（主从模式）：备份数据、负载均衡，一个Master可以有多个Slaves。**

**Sentinel（哨兵模式）：发现 Master 挂了后，就会从 Slave 中重新选举一个 Master。**

**Cluster（集群模式）：是为了解决单机Redis容量有限的问题，将数据按一定的规则分配到多台机器。**

**`Sentinel着眼于高可用，Cluster提高并发量。`**

**1. 主从模式**：读写分离，备份，一个 Master 可以有多个 Slaves。

**2. 哨兵模式**：监控，自动转移，哨兵发现主服务器挂了后，就会从 Slave 中重新选举一个主服务器。

**3. 集群模式**：为了解决单机Redis容量有限的问题，将数据按一定的规则分配到多台机器，内存/QPS不受限于单机，可受益于分布式集群高扩展性。
